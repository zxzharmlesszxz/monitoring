#!/usr/bin/env php
<?php
define('MONENGINE', 'Remake by starky');
require_once __DIR__ . "/../include/core.php";
require_once __DIR__ . "/../include/Provider.php";
require_once __DIR__ . "/../include/CronWorker.php";
require_once __DIR__ . "/../include/CronPool.php";
require_once __DIR__ . "/../include/Work.php";

$threads = 32;
$provider = new Provider();

$pool = new CronPool($threads,
    'CronWorker',
    [
        $provider,
        config()->mysql['host'],
        config()->mysql['user'],
        config()->mysql['password'],
        config()->mysql['database'],
        config()->mysql['charset']
    ]);
$start = microtime(true);

$workers = $threads;

for ($i = 0; $i < $workers; $i++) {
    $pool->submit(new Work());
}

$pool->destruct(
        config()->mysql['host'],
        config()->mysql['user'],
        config()->mysql['password'],
        config()->mysql['database'],
        config()->mysql['charset']
)->shutdown();

printf("Done for %.2f seconds" . PHP_EOL, microtime(true) - $start);
